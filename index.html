<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Rifa Masajeador HoMedics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg1: #050914;
      --bg2: #071a2c;
      --card: rgba(10, 25, 41, 0.96);
      --accent: #ffb300;
      --accent2: #00d4ff;
      --accent3: #ff6b3d;
      --text: #f5f5f5;
      --muted: #a9b7c6;
      --border: rgba(255, 255, 255, 0.12);
      --danger: #ff4b5c;
      --success: #3ddc97;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, var(--bg2), var(--bg1));
      color: var(--text);
      padding: 12px;
    }

    .app {
      width: min(520px, 100%);
    }

    .card {
      background: var(--card);
      border-radius: 22px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
      padding: 20px 18px 18px;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -45%;
      background: conic-gradient(
        from 140deg,
        rgba(0, 212, 255, 0.14),
        transparent,
        rgba(255, 179, 0, 0.18),
        transparent
      );
      opacity: 0.8;
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .header {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 14px;
    }

    .title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    h1 {
      margin: 0;
      font-size: 1.4rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .pill {
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: rgba(0, 212, 255, 0.16);
      color: var(--accent2);
      border: 1px solid rgba(0, 212, 255, 0.25);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      white-space: nowrap;
    }

    h2 {
      margin: 0;
      font-size: 1.05rem;
      font-weight: 500;
      color: var(--text);
    }

    .subtitle {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .main-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
    }

    .display-area {
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .display-number {
      width: 220px;
      max-width: 100%;
      height: 110px;
      border-radius: 22px;
      background: radial-gradient(circle at top, #1b3147, #050910);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      color: var(--accent);
      text-shadow: 0 0 18px rgba(255, 179, 0, 0.7);
      position: relative;
      overflow: hidden;
      transition: transform 0.15s ease-out;
    }

    .display-number span {
      transition: transform 0.15s ease-out;
    }

    .winner-name {
      font-size: 0.95rem;
      color: var(--text);
      min-height: 1.2em;
      text-align: center;
    }

    .helper {
      font-size: 0.8rem;
      color: var(--muted);
      text-align: center;
    }

    .buttons-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 12px 16px;
      font-size: 0.98rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out,
        filter 0.12s ease-out, background-color 0.12s ease-out,
        opacity 0.12s ease-out;
      white-space: nowrap;
    }

    .btn-primary {
      flex: 1;
      background: linear-gradient(135deg, var(--accent), var(--accent3));
      color: #1a1300;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
    }

    .btn-secondary {
      background: rgba(0, 212, 255, 0.12);
      color: var(--accent2);
      border: 1px solid rgba(0, 212, 255, 0.3);
      padding-inline: 14px;
    }

    .list-section {
      margin-top: 16px;
      padding-top: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 6px;
      gap: 8px;
    }

    .list-header strong {
      color: var(--text);
      font-size: 0.9rem;
    }

    .counter-pill {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.05);
      font-size: 0.78rem;
    }

    .list {
      max-height: 180px;
      overflow: auto;
      padding-right: 4px;
    }

    .chip {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 9px;
      border-radius: 999px;
      background: rgba(7, 33, 53, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.06);
      font-size: 0.8rem;
      margin-bottom: 6px;
      gap: 6px;
    }

    .chip-number {
      font-weight: 700;
      letter-spacing: 0.1em;
      color: var(--accent2);
      min-width: 2.9em;
    }

    .chip-name {
      flex: 1;
      color: var(--text);
    }

    .chip-ts {
      font-size: 0.7rem;
      color: var(--muted);
      white-space: nowrap;
    }

    .empty-state {
      font-size: 0.8rem;
      color: var(--muted);
      text-align: center;
      padding: 10px 4px;
    }

    .status {
      margin-top: 8px;
      font-size: 0.78rem;
      color: var(--muted);
      min-height: 1em;
    }

    .status.ok {
      color: var(--success);
    }

    .status.error {
      color: var(--danger);
    }

    /* MODAL */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
      padding: 10px;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      width: min(420px, 100%);
      background: #071321;
      border-radius: 18px;
      padding: 16px 14px 14px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.8);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }

    .modal-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .modal-close {
      border-radius: 999px;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.06);
      color: var(--muted);
      font-size: 0.85rem;
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 0.88rem;
    }

    label {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 2px;
      display: block;
    }

    input,
    select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      padding: 8px 10px;
      background: rgba(2, 12, 24, 0.96);
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
    }

    input:focus,
    select:focus {
      border-color: var(--accent2);
      box-shadow: 0 0 0 1px rgba(0, 212, 255, 0.4);
    }

    .modal-footer {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-direction: row-reverse;
    }

    .btn-save {
      background: linear-gradient(135deg, var(--accent2), #29ff9c);
      color: #001b14;
      font-weight: 600;
    }

    .btn-cancel {
      background: rgba(255, 255, 255, 0.06);
      color: var(--muted);
    }

    .modal-note {
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 4px;
    }

    @media (max-width: 480px) {
      .display-number {
        height: 95px;
        font-size: 2.4rem;
      }
      .buttons-row {
        flex-direction: column;
      }
      button {
        width: 100%;
      }
      .list {
        max-height: 160px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="card-inner">
        <div class="header">
          <div class="title-row">
            <h1>Rifa</h1>
            <div class="pill">Masajeador Homedics</div>
          </div>
          <h2>Masajeador de espalda con calor</h2>
          <div class="subtitle">100 n√∫meros ¬∑ $20.000 cada uno</div>
        </div>

        <div class="main-actions">
          <div class="display-area">
            <div class="display-number" id="display">
              <span id="displayNumber">---</span>
            </div>
            <div class="winner-name" id="winnerName"></div>
            <div class="helper" id="helper">
              Usar solo cuando ya est√©n cargados todos los compradores üòâ
            </div>
          </div>

          <div class="buttons-row">
            <button class="btn-primary" id="btnSort">
              <span class="icon">üéüÔ∏è</span>
              <span id="btnSortText">Sortear ganador</span>
            </button>
            <button class="btn-secondary" id="btnOpenModal">
              <span class="icon">‚ûï</span>
              Registrar comprador
            </button>
          </div>
        </div>

        <div class="list-section">
          <div class="list-header">
            <div><strong>N√∫meros vendidos</strong></div>
            <div class="counter-pill">
              Vendidos: <span id="soldCount">0</span> / 100
            </div>
          </div>
          <div class="list" id="buyersList">
            <div class="empty-state">
              No hay n√∫meros cargados todav√≠a. Empez√° registrando compradores.
            </div>
          </div>
          <div class="status" id="statusMsg"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Registrar comprador</div>
        <button class="modal-close" id="btnCloseModal">Cerrar</button>
      </div>
      <div class="modal-body">
        <div>
          <label for="numeroInput">N√∫mero (1 a 100)</label>
          <select id="numeroInput"></select>
        </div>
        <div>
          <label for="nombreInput">Nombre</label>
          <input
            id="nombreInput"
            type="text"
            placeholder="Ej: Juan, Marta, Luis..."
            autocomplete="off"
          />
        </div>
        <div class="modal-note">
          Si un n√∫mero ya tiene comprador, aparecer√° marcado como
          <strong>vendido</strong> y no se podr√° elegir.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-save" id="btnSaveBuyer">
          <span class="icon">üíæ</span> Guardar
        </button>
        <button class="btn-cancel" id="btnCancelModal">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    // URL de tu Google Apps Script (API)
    const API_URL =
      "https://script.google.com/macros/s/AKfycbzNEDvpY5qkPoSBzcjOu-r7DJm5-ZFZyrW0sd6jA_rpQRqEag8ApfuqDewMcUm16hg/exec";

    const display = document.getElementById("display");
    const displayNumber = document.getElementById("displayNumber");
    const winnerName = document.getElementById("winnerName");
    const helper = document.getElementById("helper");
    const btnSort = document.getElementById("btnSort");
    const btnSortText = document.getElementById("btnSortText");
    const buyersList = document.getElementById("buyersList");
    const soldCountEl = document.getElementById("soldCount");
    const statusMsg = document.getElementById("statusMsg");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const btnOpenModal = document.getElementById("btnOpenModal");
    const btnCloseModal = document.getElementById("btnCloseModal");
    const btnCancelModal = document.getElementById("btnCancelModal");
    const btnSaveBuyer = document.getElementById("btnSaveBuyer");
    const numeroInput = document.getElementById("numeroInput");
    const nombreInput = document.getElementById("nombreInput");

    let isSorting = false;
    let buyersMap = {}; // { numero: { nombre, timestamp } }

    function setStatus(message, type = "") {
      statusMsg.textContent = message || "";
      statusMsg.classList.remove("ok", "error");
      if (type === "ok") statusMsg.classList.add("ok");
      if (type === "error") statusMsg.classList.add("error");
    }

    function openModal() {
      modalBackdrop.classList.add("show");
      nombreInput.value = "";
      nombreInput.focus();
      refreshNumeroOptions();
    }

    function closeModal() {
      modalBackdrop.classList.remove("show");
    }

    function refreshNumeroOptions() {
      numeroInput.innerHTML = "";
      for (let i = 1; i <= 100; i++) {
        const opt = document.createElement("option");
        opt.value = i;
        const numStr = String(i).padStart(2, "0");
        if (buyersMap[i]) {
          opt.textContent = `${numStr} ‚Äì ${buyersMap[i].nombre} (vendido)`;
          opt.disabled = true;
        } else {
          opt.textContent = `${numStr}`;
        }
        numeroInput.appendChild(opt);
      }

      const firstAvailable = Array.from(numeroInput.options).find(
        (o) => !o.disabled
      );
      if (firstAvailable) {
        numeroInput.value = firstAvailable.value;
      }
    }

    async function fetchBuyers() {
      try {
        setStatus("Cargando datos desde la nube...");
        const res = await fetch(API_URL, { method: "GET" });
        if (!res.ok) throw new Error("Error HTTP " + res.status);
        const data = await res.json();

        buyersMap = {};
        data.forEach((row) => {
          const num = parseInt(row.numero, 10);
          if (!num || num < 1 || num > 100) return;
          buyersMap[num] = {
            nombre: row.nombre || "",
            timestamp: row.timestamp || "",
          };
        });

        renderBuyersList();
        setStatus("Datos actualizados.", "ok");
      } catch (err) {
        console.error(err);
        setStatus("No se pudieron cargar los datos. Revisar conexi√≥n.", "error");
      }
    }

    function renderBuyersList() {
      buyersList.innerHTML = "";
      const entries = Object.entries(buyersMap).sort(
        (a, b) => Number(a[0]) - Number(b[0])
      );
      soldCountEl.textContent = entries.length;

      if (entries.length === 0) {
        const div = document.createElement("div");
        div.className = "empty-state";
        div.textContent =
          "No hay n√∫meros cargados todav√≠a. Empez√° registrando compradores.";
        buyersList.appendChild(div);
        return;
      }

      entries.forEach(([num, info]) => {
        const chip = document.createElement("div");
        chip.className = "chip";

        const numEl = document.createElement("div");
        numEl.className = "chip-number";
        numEl.textContent = String(num).padStart(2, "0");

        const nameEl = document.createElement("div");
        nameEl.className = "chip-name";
        nameEl.textContent = info.nombre || "(Sin nombre)";

        const tsEl = document.createElement("div");
        tsEl.className = "chip-ts";
        if (info.timestamp) {
          const d = new Date(info.timestamp);
          if (!isNaN(d.getTime())) {
            tsEl.textContent =
              d.toLocaleDateString() + " " + d.toLocaleTimeString().slice(0, 5);
          } else {
            tsEl.textContent = "";
          }
        }

        chip.appendChild(numEl);
        chip.appendChild(nameEl);
        chip.appendChild(tsEl);
        buyersList.appendChild(chip);
      });
    }

    async function saveBuyer() {
      const num = parseInt(numeroInput.value, 10);
      const nombre = nombreInput.value.trim();

      if (!num || num < 1 || num > 100) {
        alert("Eleg√≠ un n√∫mero v√°lido entre 1 y 100.");
        return;
      }
      if (!nombre) {
        alert("Ingres√° el nombre del comprador.");
        return;
      }

      if (buyersMap[num]) {
        const ok = confirm(
          `El n√∫mero ${num} ya est√° asignado a "${buyersMap[num].nombre}". ¬øQuer√©s sobrescribirlo con "${nombre}"?`
        );
        if (!ok) return;
      }

      try {
        btnSaveBuyer.disabled = true;
        btnSaveBuyer.textContent = "Guardando...";

        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ numero: num, nombre }),
        });

        if (!res.ok) throw new Error("Error HTTP " + res.status);
        const json = await res.json();
        if (json.status !== "ok") {
          throw new Error("Respuesta inesperada de la API");
        }

        setStatus(`N√∫mero ${num} guardado para ${nombre}.`, "ok");
        closeModal();
        await fetchBuyers();
      } catch (err) {
        console.error(err);
        alert("No se pudo guardar. Revis√° conexi√≥n o la API.");
        setStatus("Error al guardar n√∫mero.", "error");
      } finally {
        btnSaveBuyer.disabled = false;
        btnSaveBuyer.textContent = "üíæ Guardar";
      }
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    async function sortWinner() {
      if (isSorting) return;
      const soldNumbers = Object.keys(buyersMap).map((n) => Number(n));
      if (soldNumbers.length === 0) {
        alert("Todav√≠a no hay n√∫meros vendidos cargados.");
        return;
      }

      isSorting = true;
      btnSort.disabled = true;
      btnSortText.textContent = "Sorteando...";
      helper.textContent = "Mostr√° la pantalla mientras gira el n√∫mero üòâ";
      winnerName.textContent = "";

      let ticks = 0;
      const totalTicks = 25 + randomInt(0, 10);

      const interval = setInterval(() => {
        ticks++;
        const tmp = soldNumbers[randomInt(0, soldNumbers.length - 1)];
        displayNumber.textContent = String(tmp).padStart(3, "0");
        display.style.transform = "scale(1.06)";
        setTimeout(() => {
          display.style.transform = "scale(1)";
        }, 90);

        if (ticks >= totalTicks) {
          clearInterval(interval);
          const winnerNumber =
            soldNumbers[randomInt(0, soldNumbers.length - 1)];
          const info = buyersMap[winnerNumber];

          displayNumber.textContent = String(winnerNumber).padStart(3, "0");
          winnerName.textContent = info
            ? `Ganador: ${info.nombre} (n¬∫ ${winnerNumber})`
            : `Ganador: n√∫mero ${winnerNumber}`;
          helper.textContent =
            "Pod√©s sacar captura de pantalla como comprobante del sorteo.";

          btnSortText.textContent = "Volver a sortear";
          btnSort.disabled = false;
          isSorting = false;
        }
      }, 120);
    }

    // EVENTOS
    btnOpenModal.addEventListener("click", openModal);
    btnCloseModal.addEventListener("click", closeModal);
    btnCancelModal.addEventListener("click", closeModal);
    btnSaveBuyer.addEventListener("click", saveBuyer);
    btnSort.addEventListener("click", sortWinner);

    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) {
        closeModal();
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });

    // INICIO
    fetchBuyers();
  </script>
</body>
</html>
